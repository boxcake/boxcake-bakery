---
# Stage 1: Bootstrap system and web configuration service
- name: "Bootstrap Home Lab System"
  hosts: localhost
  become: yes
  gather_facts: yes
  connection: local

  vars:
    homelab_user: "homelab"
    homelab_group: "homelab"
    homelab_home: "/opt/homelab"
    web_config_port: 8080

  tasks:
    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install essential packages
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - curl
          - git
          - sudo
        state: present

    - name: Install Node.js repository
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list

    - name: Install Node.js
      apt:
        name: nodejs
        state: present
        update_cache: yes

    - name: Create homelab group
      group:
        name: "{{ homelab_group }}"
        state: present

    - name: Create homelab user
      user:
        name: "{{ homelab_user }}"
        group: "{{ homelab_group }}"
        home: "{{ homelab_home }}"
        shell: /bin/bash
        create_home: no  # We'll manage the directory ourselves
        state: present

    - name: Add homelab user to sudo group
      user:
        name: "{{ homelab_user }}"
        groups: sudo
        append: yes

    - name: Create sudoers file for homelab user with full permissions
      copy:
        content: |
          # Homelab user full administrative permissions
          {{ homelab_user }} ALL=(ALL) NOPASSWD: ALL
        dest: /etc/sudoers.d/homelab
        mode: '0440'
        validate: 'visudo -cf %s'

    - name: Ensure homelab directory exists and has correct ownership
      file:
        path: "{{ homelab_home }}"
        state: directory
        owner: "{{ homelab_user }}"
        group: "{{ homelab_group }}"
        mode: '0755'
        recurse: yes

    - name: Install Ansible for homelab user
      pip:
        name: ansible
        state: present
        break_system_packages: yes
        executable: pip3

    - name: Create .ansible directory for homelab user
      file:
        path: "{{ homelab_home }}/.ansible"
        state: directory
        owner: "{{ homelab_user }}"
        group: "{{ homelab_group }}"
        mode: '0755'

    - name: Install Ansible collections (as root initially)
      command: ansible-galaxy collection install kubernetes.core community.general --force

    - name: Copy Ansible collections to homelab user directory
      shell: |
        mkdir -p {{ homelab_home }}/.ansible
        if [ -d /root/.ansible ]; then
          cp -r /root/.ansible/* {{ homelab_home }}/.ansible/ || true
        fi
        chown -R {{ homelab_user }}:{{ homelab_group }} {{ homelab_home }}/.ansible

    - name: Create centralized Python virtual environment
      shell: |
        sudo -u {{ homelab_user }} python3 -m venv "{{ homelab_home }}/venv"
      args:
        creates: "{{ homelab_home }}/venv"

    - name: Install Python dependencies
      shell: |
        sudo -u {{ homelab_user }} {{ homelab_home }}/venv/bin/pip install -r {{ homelab_home }}/web-config/backend/requirements.txt

    - name: Install npm dependencies
      shell: |
        cd {{ homelab_home }}/web-config/frontend
        sudo -u {{ homelab_user }} npm install

    - name: Build React frontend
      shell: |
        cd {{ homelab_home }}/web-config/frontend
        sudo -u {{ homelab_user }} npm run build

    - name: Create systemd service for web configuration
      template:
        src: homelab-web-config.service.j2
        dest: /etc/systemd/system/homelab-web-config.service
        mode: '0644'
      notify:
        - reload systemd
        - restart web service

    - name: Enable and start web configuration service
      systemd:
        name: homelab-web-config
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Wait for web service to be ready
      uri:
        url: "http://localhost:{{ web_config_port }}/api/health"
        method: GET
      register: web_health_check
      until: web_health_check.status == 200
      retries: 30
      delay: 2

    - name: Display setup completion message
      debug:
        msg: |
          üéâ Stage 1 Bootstrap Complete!

          ‚úÖ System prepared with essential packages
          ‚úÖ Homelab user created with sudo permissions
          ‚úÖ Ansible installed and configured
          ‚úÖ Web configuration service running

          üåê Next Steps:
          1. Access the configuration interface: http://{{ ansible_default_ipv4.address }}:{{ web_config_port }}
          2. Complete the configuration wizard
          3. Click "Deploy Now" to start Stage 2 deployment

          üë§ Management user: {{ homelab_user }}
          üè† Project location: {{ homelab_home }}/homelab-project/

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

    - name: restart web service
      systemd:
        name: homelab-web-config
        state: restarted