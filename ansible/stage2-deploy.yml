---
- name: Stage 2 - Full Home Lab Deployment
  hosts: localhost
  connection: local
  become: yes
  vars:
    homelab_user: "homelab"
    homelab_group: "homelab"
    homelab_home: "/opt/homelab"

  pre_tasks:
    - name: Check if user configuration exists
      stat:
        path: "{{ homelab_home }}/configs/user-config.yaml"
      register: user_config_stat

    - name: Load user configuration
      include_vars: "{{ homelab_home }}/configs/user-config.yaml"
      when: user_config_stat.stat.exists

    - name: Check if network configuration exists
      stat:
        path: "{{ homelab_home }}/configs/network-defaults.yaml"
      register: network_config_stat

    - name: Load network configuration
      include_vars: "{{ homelab_home }}/configs/network-defaults.yaml"
      when: network_config_stat.stat.exists

  roles:
    - k3s
    - storage
    - load-balancer
    - kubelish
    - opentofu

  post_tasks:

    - name: Final deployment summary
      debug:
        msg: |
          üéâ Stage 2 Deployment Complete!

          Your homelab is now running with the following services:
          {% if deployment.services.portainer | default(false) %}
          ‚Ä¢ Portainer - Container Management UI
          {% endif %}
          {% if deployment.services.registry | default(false) %}
          ‚Ä¢ Docker Registry - Private container registry
          {% endif %}
          {% if deployment.services.registry_ui | default(false) %}
          ‚Ä¢ Registry UI - Web interface for registry
          {% endif %}

          Access your services through the configured network:
          ‚Ä¢ Pod CIDR: {{ network.pod_cidr | default('10.42.0.0/16') }}
          ‚Ä¢ Service CIDR: {{ network.service_cidr | default('10.43.0.0/16') }}

          üåê Web interface still available at: http://{{ ansible_default_ipv4.address }}:8080
          üìÅ All configuration files in: {{ homelab_home }}/configs/